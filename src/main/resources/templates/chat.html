<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Локальный чат</title>
</head>
<body>
<h1>Локальный чат</h1>

<div>
    <p>Ваш IP: <span id="ipDisplay" th:text="${ipAdress}">неизвестно</span></p>
    <p>Ваш ник: <span id="userNickname">неизвестно</span></p>
</div>

<hr>

<!-- Контейнер сообщений -->
<div id="messagesContainer" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">
    <p>Сообщения загружаются...</p>
</div>

<!-- Форма отправки -->
<div style="margin-top: 10px;">
    <input type="text" id="messageInput" placeholder="Введите сообщение..." style="width: 300px;">
    <button onclick="sendMessage()">Отправить</button>
    <button onclick="loadMessages()">Обновить</button>
</div>

<hr>

<!-- Навигация -->
<div>
    <button onclick="goToHome()">Главная</button>
    <button onclick="goToAbout()">О проекте</button>
    <button onclick="clearChat()">Очистить историю</button>
</div>

<div id="statusMessage"></div>

<script>
    // Глобальные переменные
    let currentUser = null;
    let currentIp = document.getElementById('ipDisplay').textContent;

    // Инициализация при загрузке
    async function initChat() {
        try {
            // 1. Получаем или создаем пользователя
            let response = await fetch(`/api/users?ip=${encodeURIComponent(currentIp)}`);

            if (!response.ok) {
                // Создаем нового пользователя
                response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ipAdress: currentIp})
                });
            }

            if (response.ok) {
                currentUser = await response.json();
                document.getElementById('userNickname').textContent = currentUser.nickname;
            }

            // 2. Загружаем сообщения
            await loadMessages();

            // 3. Настраиваем автообновление каждые 5 секунд
            setInterval(loadMessages, 5000);

        } catch (error) {
            showStatus('Ошибка инициализации: ' + error.message);
        }
    }

    // Загрузить сообщения
    async function loadMessages() {
        try {
            const response = await fetch('/api/messages?limit=50');
            if (!response.ok) throw new Error('Не удалось загрузить сообщения');

            const messages = await response.json();
            displayMessages(messages);

        } catch (error) {
            showStatus('Ошибка загрузки: ' + error.message);
        }
    }

    // Отобразить сообщения
    function displayMessages(messages) {
        const container = document.getElementById('messagesContainer');

        if (!messages || messages.length === 0) {
            container.innerHTML = '<p>Нет сообщений. Будьте первым!</p>';
            return;
        }

        let html = '';
        messages.forEach(msg => {
            const time = new Date(msg.createdAt).toLocaleTimeString();
            html += `
                <div>
                    <strong>${escapeHtml(msg.senderNickname)}</strong>
                    <small>(${time})</small>:
                    ${escapeHtml(msg.content)}
                </div>
                <hr>
            `;
        });

        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }

    // Отправить сообщение
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message) {
            showStatus('Введите сообщение');
            return;
        }

        if (!currentUser) {
            showStatus('Сначала получите никнейм на главной странице');
            return;
        }

        try {
            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content: message,
                    ipAdress: currentIp
                })
            });

            if (response.ok) {
                input.value = '';
                await loadMessages(); // Обновляем сообщения
                showStatus('Сообщение отправлено');
            } else {
                showStatus('Ошибка отправки');
            }
        } catch (error) {
            showStatus('Ошибка: ' + error.message);
        }
    }

    // Очистить историю (старые сообщения)
    async function clearChat() {
        if (confirm('Удалить сообщения старше 30 дней?')) {
            try {
                await fetch('/api/messages/1', {method: 'DELETE'});
                showStatus('Старые сообщения удалены');
                await loadMessages();
            } catch (error) {
                showStatus('Ошибка очистки: ' + error.message);
            }
        }
    }

    // Навигация
    function goToHome() {
        window.location.href = '/';
    }

    function goToAbout() {
        window.location.href = '/about';
    }

    // Показать статус
    function showStatus(message) {
        document.getElementById('statusMessage').innerHTML = message;
        setTimeout(() => {
            document.getElementById('statusMessage').innerHTML = '';
        }, 3000);
    }

    // Экранирование HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Запуск при загрузке страницы
    document.addEventListener('DOMContentLoaded', initChat);

    // Отправка по Enter
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>