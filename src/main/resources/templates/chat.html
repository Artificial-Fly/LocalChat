<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
</head>
<body>

<h2>LocalChat</h2>

<div id="messages" style="border:1px solid #ccc; height:300px; overflow:auto;"></div>

<input id="messageInput" placeholder="message">
<button onclick="sendMessage()">Send</button>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    /* UUID ПРИШЁЛ С СЕРВЕРА */
    const UUID = "[[${uuid}]]";

    if (!UUID || UUID === "null") {
        alert("UUID not found (server)");
        throw new Error("UUID missing");
    }

    let stompClient = null;
    const messagesDiv = document.getElementById("messages");

    /* ---------- LOAD HISTORY ---------- */
    fetch("/api/messages?limit=20")
        .then(r => r.json())
        .then(list => {
            list.reverse().forEach(m => {
                addMessage(m.senderNickname, m.content);
            });
        });

    /* ---------- WS ---------- */
    function connect() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, () => {
            stompClient.subscribe("/topic/messages", msg => {
                const m = JSON.parse(msg.body);
                addMessage(m.sender, m.content);
            });
        });
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const text = input.value.trim();
        if (!text) return;

        stompClient.send("/app/chat/send", {}, JSON.stringify({
            content: text,
            uuid: UUID
        }));

        input.value = "";
    }

    function addMessage(sender, text) {
        const div = document.createElement("div");
        div.textContent = sender + ": " + text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    connect();
</script>

</body>
</html>
